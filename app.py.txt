import streamlit as st
import pandas as pd
from fuzzywuzzy import fuzz
import os

# Load FAQ
faq_file = 'faq.xlsx'
unanswered_file = 'unanswered.xlsx'

# --- Load or create Excel files ---
if os.path.exists(Chatbot_MIS_fuzz):
    faq_df = pd.read_excel(Chatbot_MIS_fuzz)
else:
    faq_df = pd.DataFrame(columns=["Category", "Keyword", "Question", "Answer"])
    faq_df.to_excel(faq_file, index=False)

if os.path.exists(unanswered_file):
    unanswered_df = pd.read_excel(unanswered_file)
else:
    unanswered_df = pd.DataFrame(columns=["Category", "Question"])
    unanswered_df.to_excel(unanswered_file, index=False)

# --- App Title and Logo ---
st.set_page_config(page_title="IIMJ MITRA", layout="wide")
st.markdown("<h1 style='text-align: center; color: #0E4D92;'>IIM Smart Chatbot</h1>", unsafe_allow_html=True)
st.image("logo.png", width=120)

tab1, tab2 = st.tabs(["ü§ñ Chatbot", "üõ†Ô∏è Admin Panel"])

# --- CHATBOT TAB ---
with tab1:
    st.markdown("### Ask a Question")
    categories = faq_df["Category"].dropna().unique()
    selected_cat = st.selectbox("Select a category", categories)

    user_q = st.text_input("Type your question here")

    if st.button("Get Answer"):
        matched_faqs = faq_df[faq_df["Category"] == selected_cat]
        scores = matched_faqs["Question"].apply(lambda q: fuzz.ratio(str(q).lower(), user_q.lower()))
        
        if scores.max() >= 70:
            best_idx = scores.idxmax()
            answer = faq_df.loc[best_idx, "Answer"]
            st.success(f"**Answer:** {answer}")
        else:
            st.warning("Sorry, I don't know the answer yet. We'll get back to you soon!")
            if not ((unanswered_df["Question"] == user_q) & (unanswered_df["Category"] == selected_cat)).any():
                new_entry = pd.DataFrame({"Category": [selected_cat], "Question": [user_q]})
                unanswered_df = pd.concat([unanswered_df, new_entry], ignore_index=True)
                unanswered_df.to_excel(unanswered_file, index=False)

# --- ADMIN PANEL TAB ---
with tab2:
    st.markdown("### Manage Unanswered Questions")
    admin_cat = st.selectbox("Select category (Admin)", unanswered_df["Category"].dropna().unique())

    cat_questions = unanswered_df[unanswered_df["Category"] == admin_cat]["Question"].drop_duplicates()
    admin_q = st.selectbox("Select question to answer", cat_questions)

    admin_ans = st.text_area("Enter your answer here")

    if st.button("Submit Answer"):
        new_faq = pd.DataFrame({
            "Category": [admin_cat],
            "Keyword": [""],
            "Question": [admin_q],
            "Answer": [admin_ans]
        })
        faq_df = pd.concat([faq_df, new_faq], ignore_index=True)
        faq_df.to_excel(faq_file, index=False)

        unanswered_df = unanswered_df[~((unanswered_df["Category"] == admin_cat) & (unanswered_df["Question"] == admin_q))]
        unanswered_df.to_excel(unanswered_file, index=False)

        st.success("‚úÖ Answer added to FAQ and removed from unanswered list!")

# --- Chatbot or Admin content goes here ---

# End of all your page content
st.markdown("<hr><center><i>FAQs sourced from the IIM Jammu Handbook</i></center>", unsafe_allow_html=True)

# Footer with your name
st.markdown("<hr><center>Developed with ‚ù§Ô∏è by Paryul Bhawsar, IIM Jammu</center>", unsafe_allow_html=True)

